name: Update tiles

on:
  push:
    paths:
      - "tiles/**/*"
    branches:
      - "main"
  schedule:
    - cron: "0 4 * * THU"
  workflow_dispatch:

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install osmconvert
        run: wget http://m.m.i24.cc/osmconvert64 && chmod +x osmconvert64
      - name: Download OSM data
        run: wget https://download.openstreetmap.fr/extracts/oceania/australia/new_south_wales.osm.pbf
      - name: Crop OSM data
        run: ./osmconvert64 new_south_wales.osm.pbf -o=tiles/data.osm.pbf --complete-ways -B=tiles/bbox.poly
      - name: Download coastline
        run: wget https://osmdata.openstreetmap.de/download/water-polygons-split-4326.zip
      - name: Extract coastline
        run: unzip -j -d coastline water-polygons-split-4326.zip
  generate-tiles:
    runs-on: ubuntu-latest
    container: ghcr.io/systemed/tilemaker:master
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Generate tiles
        run: tilemaker --input ./tiles/data.osm.pbf --output ./tiles/output --config ./tiles/config.json --process ./tiles/process.lua
      - name: Remove duplicate files
        run: cd tiles && sudo ./remove-duplicates.sh
      - name: Copy Cloudflare Pages config files to output folder
        run: sudo cp ./tiles/_headers ./tiles/output/_headers && sudo cp ./tiles/_redirects ./tiles/output/_redirects && sudo cp ./tiles/water-tile.pbf ./tiles/output/404.html
      # https://github.com/cloudflare/pages-action#readme
      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sydneybikemap-tiles
          directory: tiles/output
          # Optional: Enable this if you want to have GitHub Deployments triggered
          # gitHubToken: ${{ secrets.GITHUB_TOKEN }}
